# HAProxy Configuration for UFX.Relay Load Balancing
# This configuration demonstrates load balancing multiple UFX.Relay forwarder instances
# with sticky sessions and WebSocket support

global
    # Logging
    log /dev/log local0
    log /dev/log local1 notice
    
    # SSL configuration
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    
    # Performance tuning
    maxconn 4096
    tune.ssl.default-dh-param 2048

defaults
    log global
    mode http
    option httplog
    option dontlognull
    option http-server-close
    option forwardfor except 127.0.0.0/8
    option redispatch
    
    # Timeouts
    timeout connect 5000
    timeout client 3600000  # 1 hour for WebSocket
    timeout server 3600000  # 1 hour for WebSocket
    timeout tunnel 7200000  # 2 hours for WebSocket tunnel
    timeout http-request 10s
    timeout http-keep-alive 10s
    
    # Retry and error handling
    retries 3
    maxconn 3000

# Frontend for HTTPS traffic
frontend https_front
    bind *:443 ssl crt /etc/haproxy/certs/relay.example.com.pem
    
    # Logging
    log-format "%ci:%cp [%tr] %ft %b/%s %TR/%Tw/%Tc/%Tr/%Ta %ST %B %CC %CS %tsc %ac/%fc/%bc/%sc/%rc %sq/%bq %hr %hs %{+Q}r"
    
    # HTTP Strict Transport Security
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # ACL for WebSocket upgrade
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_websocket hdr_beg(Host) -i ws
    
    # ACL for tunnel path
    acl is_tunnel path_beg /tunnel/
    
    # Health check endpoint (handled by HAProxy)
    acl is_haproxy_health path /haproxy-health
    
    # Use relay backend for all requests
    use_backend haproxy_health if is_haproxy_health
    default_backend relay_backend

# Frontend for HTTP (redirect to HTTPS)
frontend http_front
    bind *:80
    
    # Redirect all HTTP to HTTPS
    redirect scheme https code 301 if !{ ssl_fc }

# Backend for relay forwarder instances
backend relay_backend
    # Load balancing algorithm with sticky sessions
    # Source: Uses client's source IP for stickiness
    balance source
    
    # Alternative: Cookie-based stickiness (more reliable for NAT scenarios)
    # Uncomment the following lines to use cookie-based stickiness instead:
    # balance roundrobin
    # cookie SERVERID insert indirect nocache
    
    # Health check configuration
    option httpchk GET /health
    http-check expect status 200
    
    # WebSocket support
    option http-server-close
    option forwardfor
    
    # Forward headers
    http-request set-header X-Forwarded-Proto https if { ssl_fc }
    http-request set-header X-Forwarded-Proto http if !{ ssl_fc }
    http-request add-header X-Forwarded-Host %[req.hdr(Host)]
    http-request add-header X-Forwarded-Port %[dst_port]
    
    # Server definitions
    # Format: server <name> <address>:<port> [options]
    # For cookie-based stickiness, add: cookie <value>
    
    server forwarder1 forwarder1.example.com:443 check ssl verify none maxconn 1000
    server forwarder2 forwarder2.example.com:443 check ssl verify none maxconn 1000
    server forwarder3 forwarder3.example.com:443 check ssl verify none maxconn 1000
    
    # For local testing:
    # server forwarder1 127.0.0.1:8081 check maxconn 1000 cookie s1
    # server forwarder2 127.0.0.1:8082 check maxconn 1000 cookie s2
    # server forwarder3 127.0.0.1:8083 check maxconn 1000 cookie s3
    
    # Server options:
    # - check: Enable health checks
    # - ssl: Use SSL/TLS for backend connection
    # - verify none: Don't verify SSL certificate (for testing)
    # - maxconn: Maximum concurrent connections per server
    # - cookie: Server identifier for cookie-based stickiness

# Backend for HAProxy health check
backend haproxy_health
    mode http
    errorfile 503 /etc/haproxy/errors/200.http

# Statistics page (optional - comment out in production)
listen stats
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats auth admin:changeme  # Change this password!
    stats show-legends
    stats show-node
